<template>
    <div class="detail">
        <v-breadcrumbs :items="breadcrumbs"></v-breadcrumbs>
        <Metadata v-if="asset" :asset="asset"></Metadata>
        <section v-if="!txloading" class="card transactions">
            <!-- HEADER -->
            <header class="header">
                <TxHeader></TxHeader>
                <!-- LOAD COUNT/PAGINATION -->
                <template v-if="txloading && !assetsLoaded">
                    <v-progress-circular
                        key="1"
                        ref="paginationTop"
                        :size="16"
                        :width="2"
                        color="#E84970"
                        indeterminate
                    ></v-progress-circular>
                </template>
                <!-- <template v-else>
                    <div class="bar">
                        <p
                            class="count"
                        >{{totalTransactionCount.toLocaleString()}} transactions found</p>
                        <pagination-controls
                            :total="totalTransactionCount"
                            :limit="limit"
                            @change="page_change"
                        ></pagination-controls>
                    </div>
                </template> -->
            </header>
            <!-- TBODY -->
            <TxTableHead></TxTableHead>
            <template v-if="txloading">
                <v-progress-circular
                    key="1"
                    :size="16"
                    :width="2"
                    color="#E84970"
                    indeterminate
                ></v-progress-circular>
            </template>
            <template v-else>
                <div class="rows">
                    <transition-group name="fade">
                        <tx-row
                            v-for="tx in transactions"
                            :key="tx.id"
                            class="tx_item"
                            :transaction="tx"
                        ></tx-row>
                    </transition-group>
                </div>
                <!-- <div class="bar-table">
                    <pagination-controls :total="totalTransactionCount" :limit="limit" @change="page_change" ref="paginationBottom"></pagination-controls>
                </div> -->
            </template>
        </section>
        <template v-if="!genesisTx">
            <Loader
                :content-id="assetID"
                :message="'Fetching Asset Details'"
            ></Loader>
        </template>
        <template v-else>
            <TransactionDetailCard :tx="genesisTx"
                >Asset Genesis Details</TransactionDetailCard
            >
        </template>
    </div>
</template>

<script lang="ts">
import 'reflect-metadata'
import { Vue, Component, Watch } from 'vue-property-decorator'
import Loader from '@/components/misc/Loader.vue'
import Metadata from '@/components/Asset/Metadata.vue'
import TransactionDetailCard from '@/components/TransactionDetailCard.vue'
import PaginationControls from '@/components/misc/PaginationControls.vue'
import Tooltip from '@/components/rows/Tooltip.vue'
import TxTableHead from '@/components/rows/TxRow/TxTableHead.vue'
import TxRow from '@/components/rows/TxRow/TxRow.vue'
import { Transaction } from '../js/Transaction'
import { Asset } from '@/js/Asset'
import { getTransaction } from '@/services/transactions'
import { getAssetInfo } from '@/services/assets'
import TxHeader from '@/components/Transaction/TxHeader.vue'
import { ITransaction } from '@/js/ITransaction'

@Component({
    components: {
        Loader,
        Metadata,
        PaginationControls,
        TransactionDetailCard,
        Tooltip,
        TxTableHead,
        TxRow,
        TxHeader,
    },
})
export default class AssetPage extends Vue {
    genesisTx: Transaction | null = null
    txloading = false
    totalTx = 0
    limit = 10 // how many to display
    offset = 0
    sort = 'timestamp-desc'

    created() {
        this.getData()
    }

    @Watch('txId')
    ontxIdChanged() {
        this.getData()
    }

    @Watch('assetsLoaded')
    onAssetsLoaded() {
        this.getData()
    }

    get assetsLoaded() {
        return this.$store.state.assetsLoaded
    }

    get breadcrumbs(): any[] {
        return [
            {
                text: 'Home',
                disabled: false,
                href: '/',
            },
            {
                text: 'Assets',
                disabled: false,
                href: '/assets',
            },
            {
                text: `${
                    this.asset
                        ? this.asset.symbol
                            ? this.asset.symbol
                            : this.asset.id
                        : 'Asset'
                }`,
                disabled: true,
                href: '',
            },
        ]
    }

    get assetID(): string {
        return this.$route.params.id
    }

    get asset(): Asset {
        return this.$store.state.assets[this.$route.params.id]
    }

    get txId(): string {
        return this.$route.params.id
    }

    get transactions(): ITransaction[] {
        return this.$store.state.assetTxRes.transactions
    }

    getData(): void {
        this.txloading = true

        if (this.assetsLoaded) {
            // Get genesis tx
            Promise.all([getTransaction(this.txId), getAssetInfo(this.txId)])
                .then(([transactionInfo, assetInfo]) => {
                    return {
                        ...transactionInfo,
                        ...assetInfo,
                    }
                })
                .then((data) => {
                    const tx = new Transaction(data)
                    this.genesisTx = tx
                })
                .catch((err) => {
                    console.log(err)
                })

            // Get txs
            // TODO: support service for multiple chains
            this.$store
                .dispatch('getTransactions', {
                    mutation: 'addAssetTransactions',
                    id: null,
                    params: {
                        assetID: this.assetID,
                        sort: this.sort,
                        offset: this.offset,
                        limit: this.limit,
                    },
                })
                .then(() => (this.txloading = false))
        }
    }

    async getTx() {
        this.txloading = true

        // TODO: support service for multiple chains
        this.$store
            .dispatch('getTransactions', {
                mutation: 'addAssetTransactions',
                id: null,
                params: {
                    assetID: this.assetID,
                    sort: this.sort,
                    offset: this.offset,
                    limit: this.limit,
                },
            })
            .then(() => (this.txloading = false))
    }

    page_change(val: number) {
        this.offset = val
        this.getTx()
        const pgNum = Math.floor(this.offset / this.limit) + 1
        // @ts-ignore
        this.$refs.paginationTop.setPage(pgNum)
        // @ts-ignore
        this.$refs.paginationBottom.setPage(pgNum)
    }
}
</script>

<style scoped lang="scss">
$symbol_w: 35px;

.symbol {
    margin-left: 20px;
    text-align: center;
    line-height: $symbol_w;
    background-color: #f1f2f3;
    color: #000;
    font-size: 14px;
    font-weight: 400; /* 700 */
    box-sizing: border-box;
    height: $symbol_w;
    width: $symbol_w;
    border-radius: $symbol_w;
}

.asset_genesis {
    margin-top: 30px;
}

@include xsOnly {
    .asset_genesis {
        margin-top: 10px;
    }
}

/* ==========================================
   transactions
   ========================================== */

.transactions {
    overflow: auto;
    margin-top: 15px;
    margin-bottom: 15px;

    .tx_rows {
        width: 100%;
        border-radius: 2px;
        margin: 2px 0;
        box-sizing: border-box;
        border-bottom: 1px solid #e7e7e7;
    }

    .tx_item {
        border-bottom: 1px solid #e7e7e7;
    }

    .tx_table {
        font-size: 12px;
    }
}

.bar-table {
    padding-top: 30px;
    display: flex;
    justify-content: flex-end;
}

@include smOnly {
    .transactions {
        margin-bottom: 10px;

        .table_headers {
            display: none;
        }
    }
}
</style>
